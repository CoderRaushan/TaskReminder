<!DOCTYPE html>
<html>

<head>
  <title>Schedule Notification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 10px;
      margin: 0;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    input,
    button {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      border-radius: 5px;
      font-size: 14px;
    }

    input {
      border: 1px solid #ccc;
    }

    button {
      background: #28a745;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
    }

    button:hover {
      background: #218838;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button-group button {
      flex: 1;
      min-width: 150px;
    }

    .cleanup-btn {
      background: #dc3545 !important;
    }

    .cleanup-btn:hover {
      background: #c82333 !important;
    }

    .list {
      margin-top: 20px;
    }

    .item {
      background: #f9f9f9;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 10px;
    }

    .item-content {
      flex: 1;
      min-width: 200px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .actions i {
      cursor: pointer;
      padding: 8px;
      border-radius: 4px;
      transition: all 0.3s;
      font-size: 16px;
    }

    .actions .fa-edit {
      color: #007bff;
    }

    .actions .fa-edit:hover {
      background: #007bff;
      color: white;
    }

    .actions .fa-trash {
      color: #dc3545;
    }

    .actions .fa-trash:hover {
      background: #dc3545;
      color: white;
    }

    .status {
      font-size: 14px;
      color: #666;
      margin-top: 15px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 5px;
      text-align: center;
    }

    .edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .edit-modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .edit-modal h3 {
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    .edit-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .edit-form label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-buttons button {
      flex: 1;
      margin: 0;
    }

    .cancel-btn {
      background: #6c757d !important;
    }

    .cancel-btn:hover {
      background: #5a6268 !important;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 5px;
        border-radius: 5px;
      }

      h1 {
        font-size: 1.3rem;
      }

      .item {
        flex-direction: row;
        align-items: stretch;
      }

      .item-content {
        min-width: auto;
      }

      .actions {
        justify-content: center;
        margin-top: 10px;
      }

      .button-group {
        flex-direction: column;
      }

      .button-group button {
        min-width: auto;
      }

      .edit-modal-content {
        width: 95%;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 5px;
      }

      .container {
        padding: 10px;
      }

      h1 {
        font-size: 1.2rem;
      }

      input,
      button {
        padding: 10px;
        font-size: 16px;
        /* Prevents zoom on iOS */
      }

      .actions i {
        padding: 10px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Schedule Notification</h1>
    <form id="form">
      <input id="msg" placeholder="Enter your message" required />
      <input id="datetime" type="datetime-local" required />
      <div class="button-group">
        <button type="button" class="cleanup-btn" onclick="cleanupSubscriptions()">Clean Duplicates</button>
        <button type="submit">Schedule Notification</button>
      </div>
    </form>

    <div class="list" id="list"></div>
    <div class="status" id="status">Loading...</div>
  </div>

  <!-- Edit Modal -->
  <div class="edit-modal" id="editModal">
    <div class="edit-modal-content">
      <h3>Edit Notification</h3>
      <div class="edit-form">
        <div>
          <label for="editMsg">Message:</label>
          <input id="editMsg" type="text" placeholder="Enter message">
        </div>
        <div>
          <label for="editDateTime">Date & Time:</label>
          <input id="editDateTime" type="datetime-local">
        </div>
        <div class="modal-buttons">
          <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
          <button onclick="updateNotification()">Update</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Service Worker and Push Notification Setup

    const publicVapidKey = 'BNJ3zMpwqw4YGHVNIpxhhY1mF4YwN_PXWbal6qf9--iQYJ3yS5JMRWtFBNG5y6Skw8v_bUWRjMedTpcazL_XDys';
    let currentEditId = null;

    async function init() {
      if ('serviceWorker' in navigator) {
        try {
          // Check if already registered
          let reg = await navigator.serviceWorker.getRegistration();

          if (!reg) {
            reg = await navigator.serviceWorker.register('/sw.js');
          }

          // Check if subscription already exists
          let subscription = await reg.pushManager.getSubscription();

          if (!subscription) {
            subscription = await reg.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
            });
          }

          const response = await fetch('/subscribe', {
            method: 'POST',
            body: JSON.stringify(subscription),
            headers: { 'Content-Type': 'application/json' }
          });

          const result = await response.json();
          document.getElementById('status').textContent = `Service Worker registered. Active subscriptions: ${result.totalSubscriptions || 1}`;
        } catch (err) {
          console.error('Service worker registration failed:', err);
          document.getElementById('status').textContent = 'Service Worker registration failed';
        }
      } else {
        document.getElementById('status').textContent = 'Service Worker not supported';
      }
    }

    init();

    document.getElementById('form').onsubmit = async e => {
      e.preventDefault();
      const message = document.getElementById('msg').value;
      const dateTime = document.getElementById('datetime').value;

      // Validate future date for new notifications only
      const scheduledDate = new Date(dateTime);
      const now = new Date();

      try {
        const response = await fetch('/schedule', {
          method: 'POST',
          body: JSON.stringify({ message, dateTime }),
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          document.getElementById('form').reset();
          loadNotifications();
          document.getElementById('status').textContent = 'Notification scheduled successfully';
        } else {
          throw new Error('Failed to schedule');
        }
      } catch (err) {
        console.error('Failed to schedule notification:', err);
        document.getElementById('status').textContent = 'Failed to schedule notification';
      }
    };

    async function loadNotifications() {
      try {
        const res = await fetch('/notifications');
        const data = await res.json();
        const list = document.getElementById('list');
        list.innerHTML = "";

        if (data.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No scheduled notifications</p>';
          return;
        }

        data.forEach(n => {
          const div = document.createElement('div');
          div.className = "item";
          const scheduledTime = new Date(n.time);
          const isOverdue = scheduledTime < new Date();

          div.innerHTML = `
  <div class="item-content">
    <div style="font-weight: bold; margin-bottom: 5px;">${n.message}</div>
    <small style="color: ${isOverdue ? '#dc3545' : '#28a745'}; font-weight: bold;">
      ${scheduledTime.toLocaleString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour12: true
          })}
      ${isOverdue ? ' (Overdue)' : ''}
    </small>
  </div>
  <div class="actions">
    <i class="fa fa-edit" onclick="openEditModal('${n._id}', '${n.message.replace(/'/g, "\\'")}', '${n.time}')" title="Edit"></i>
    <i class="fa fa-trash" onclick="deleteNotif('${n._id}')" title="Delete"></i>
  </div>
`;
          list.appendChild(div);
        });

        document.getElementById('status').textContent = `${data.length} notification(s) scheduled`;
      } catch (err) {
        console.error('Failed to load notifications:', err);
        document.getElementById('status').textContent = 'Failed to load notifications';
      }
    }

    async function deleteNotif(id) {
      if (!confirm('Delete this notification?')) return;

      try {
        const response = await fetch('/notifications/' + id, { method: 'DELETE' });
        if (response.ok) {
          loadNotifications();
          document.getElementById('status').textContent = 'Notification deleted';
        } else {
          throw new Error('Delete failed');
        }
      } catch (err) {
        console.error('Failed to delete notification:', err);
        document.getElementById('status').textContent = 'Failed to delete notification';
      }
    }

    function openEditModal(id, message, time) {
      currentEditId = id;
      document.getElementById('editMsg').value = message;
      document.getElementById('editDateTime').value = time;
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditId = null;
    }

    async function updateNotification() {
      if (!currentEditId) return;

      const newMsg = document.getElementById('editMsg').value.trim();
      const newTime = document.getElementById('editDateTime').value;

      // Only check if message is not empty - no future date validation for edits
      if (!newMsg) {
        alert('Message cannot be empty');
        return;
      }

      // No validation for future date or changes - allow any update
      try {
        const response = await fetch('/notifications/' + currentEditId, {
          method: 'PUT',
          body: JSON.stringify({ message: newMsg, dateTime: newTime }),
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          closeEditModal();
          loadNotifications();
          document.getElementById('status').textContent = 'Notification updated successfully';
        } else {
          throw new Error('Update failed');
        }
      } catch (err) {
        console.error('Failed to edit notification:', err);
        document.getElementById('status').textContent = 'Failed to update notification';
      }
    }

    // Close modal when clicking outside
    document.getElementById('editModal').onclick = function (e) {
      if (e.target === this) {
        closeEditModal();
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && document.getElementById('editModal').style.display === 'flex') {
        closeEditModal();
      }
    });

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Load notifications on page load
    loadNotifications();

    // Auto-refresh every 30 seconds
    setInterval(loadNotifications, 30000);

    // Cleanup duplicate subscriptions
    async function cleanupSubscriptions() {
      if (!confirm('Remove duplicate subscriptions? This will clean up your database.')) return;

      try {
        document.getElementById('status').textContent = 'Cleaning up duplicates...';

        const response = await fetch('/cleanup-subscriptions', { method: 'POST' });
        const result = await response.json();

        if (response.ok) {
          document.getElementById('status').textContent =
            `Cleanup complete! Removed ${result.removed} duplicates. ${result.uniqueDevices} unique devices remaining.`;
        } else {
          throw new Error(result.error);
        }
      } catch (err) {
        console.error('Cleanup failed:', err);
        document.getElementById('status').textContent = 'Cleanup failed';
      }
    }

    // Check subscription stats on load
    async function checkSubscriptionStats() {
      try {
        const response = await fetch('/subscription-stats');
        const stats = await response.json();

        if (stats.duplicates > 0) {
          document.getElementById('status').textContent =
            `⚠️ Found ${stats.duplicates} duplicate subscriptions out of ${stats.totalSubscriptions} total`;
        }
      } catch (err) {
        console.log('Could not fetch subscription stats');
      }
    }

    // Check stats after loading notifications
    setTimeout(checkSubscriptionStats, 2000);
  </script>

  <!-- Inline Service Worker to avoid external file issues -->
  <script>
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('push', e => {
          const data = e.data.json();
          const options = {
            body: data.message,
            icon: '/icon.png',
            tag: 'reminder-' + Date.now(),
            requireInteraction: true,
            actions: [
              { action: 'close', title: 'Close' }
            ]
          };
          
          self.registration.showNotification('Scheduled Reminder', options);
        });

        self.addEventListener('notificationclick', e => {
          e.notification.close();
          if (e.action === 'close') {
            return;
          }
          
          e.waitUntil(
            clients.openWindow('/?msg=' + encodeURIComponent(e.notification.body))
          );
        });
      `;

      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(blob);

      navigator.serviceWorker.register(swUrl).catch(err => {
        console.error('Service worker registration failed:', err);
      });
    }
  </script>
</body>

</html>